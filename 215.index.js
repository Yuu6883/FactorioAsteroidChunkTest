(()=>{"use strict";var e={m:{},u:e=>e+".index.js"};e.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),e.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{var t;e.g.importScripts&&(t=e.g.location+"");var r=e.g.document;if(!t&&r&&(r.currentScript&&"SCRIPT"===r.currentScript.tagName.toUpperCase()&&(t=r.currentScript.src),!t)){var s=r.getElementsByTagName("script");if(s.length)for(var o=s.length-1;o>-1&&(!t||!/^http(s?):/.test(t));)t=s[o--].src}if(!t)throw new Error("Automatic publicPath is not supported in this browser");t=t.replace(/^blob:/,"").replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),e.p=t})(),e.b=self.location+"";let t=new TextDecoder("utf-8"),r=new class{flush(e){if(1===e){let e=0;for(;e<this.stdout_buffer.length;){let t=this.stdout_buffer.indexOf("\n",e);if(-1===t){this.stdout_buffer=this.stdout_buffer.slice(e);break}console.log(this.stdout_buffer.slice(e,t)),e=t+1}e===this.stdout_buffer.length&&(this.stdout_buffer="")}else if(2===e){let e=0;for(;e<this.stderr_buffer.length;){let t=this.stderr_buffer.indexOf("\n",e);if(-1===t){this.stderr_buffer=this.stderr_buffer.slice(e);break}console.error(this.stderr_buffer.slice(e,t)),e=t+1}e===this.stderr_buffer.length&&(this.stderr_buffer="")}}async init(){let e=this.memory,r={wasi_snapshot_preview1:{args_sizes_get:()=>0,args_get:()=>0,environ_sizes_get(t,r){let s=new DataView(e.buffer);return s.setUint32(t,0,!0),s.setUint32(r,0,!0),0},environ_get:()=>0,fd_write:(r,s,o,i)=>{let n=new DataView(e.buffer),l=0;for(let i=0;i<o;i++){let o=n.getUint32(s+8*i,!0),a=n.getUint32(s+8*i+4,!0),f=new Uint8Array(e.buffer,o,a),u=t.decode(f);if(1===r)this.stdout_buffer+=u,this.flush(1);else{if(2!==r)return 8;this.stderr_buffer+=u,this.flush(2)}l+=a}return n.setUint32(i,l,!0),0},fd_seek(){console.log(`fd_seek called: ${arguments}`)},fd_read(){console.log(`fd_read called: ${arguments}`)},fd_close(){console.log(`fd_close called: ${arguments}`)},proc_exit:()=>0,clock_time_get(t,r,s){s>>>=0;let o=1000000n*BigInt((new Date).getTime());return new DataView(e.buffer).setBigUint64(s,o,!0),0}},env:{memory:e,__main_argc_argv:()=>0,emscripten_notify_memory_growth(...t){console.log((e.buffer.byteLength/1024/1024).toFixed(3)+"MB"),console.log(`emscripten_notify_memory_growth called: ${JSON.stringify(t)}`)},notify_chunk_update:(t,r,s,o,i,n)=>{s?this.notify_chunk_update?.(t,r,e.buffer.slice(o,o+s*Int32Array.BYTES_PER_ELEMENT),e.buffer.slice(i,i+s*Int32Array.BYTES_PER_ELEMENT),e.buffer.slice(n,n+s*Uint32Array.BYTES_PER_ELEMENT)):this.notify_chunk_update?.(t,r,null,null,null)}}};try{let e="assets/asteroid.wasm",{instance:t}=await WebAssembly.instantiateStreaming(fetch(e),r),s=this.module=t.exports;try{s._start()}catch(e){}this.ready=!0}catch(t){console.log(`memory size: ${(e.buffer.byteLength/1024/1024).toFixed(3)}MB`),console.error("Failed to load or run asteroid.wasm:",t)}}constructor(){this.ready=!1,this.memory=new WebAssembly.Memory({initial:16384,maximum:16384}),this.stdout_buffer="",this.stderr_buffer="",this.notify_chunk_update=null}},s=self,o=new Worker(new URL(e.p+e.u(367),e.b)),i=(...e)=>{o.postMessage({args:e},e)},n={posX:null,posY:null,state:null},l=(e,t,s)=>{(!n[e]||n[e].byteLength<s)&&(n[e]&&i(n[e]),n[e]=new ArrayBuffer(s));let o=new Uint8Array(r.memory.buffer,t,s);new Uint8Array(n[e]).set(o)},a=[],f=(e=!0,t=-1/30)=>{let o=r.module.get_asteroid_size(),i=r.module.get_asteroid_pos_x(),a=r.module.get_asteroid_pos_y(),f=r.module.get_asteroid_state();l("posX",i,o*Int32Array.BYTES_PER_ELEMENT),l("posY",a,o*Int32Array.BYTES_PER_ELEMENT),l("state",f,o*Uint32Array.BYTES_PER_ELEMENT),s.postMessage({event:"tick",buffers:n,size:o},Object.values(n)),n.posX=null,n.posY=null,n.state=null,e&&r.module.tick(t)};s.addEventListener("message",({data:e})=>{if(!r.ready)return console.error("Worker not ready",e);let{call:t,args:s,buffers:o,fill:i,rng:l}=e;if("start"===t)r.module.init_map(),r.module.set_asteroid_size(s[0]||2048),r.module.fill_asteroids(s[0]||2048),f(!1);else if("sim"===t){if(n.posX||n.posY||n.state)return console.error("Buffers not cleared???");if(n.posX=o.posX,n.posY=o.posY,n.state=o.state,f(!0,s[0]),r.module.update_rng(l[0],l[1],l[2],l[3],l[4]),r.module.fill_asteroids(i||0),a.length){for(let e of a){let[t,s,o,i,n]=e;r.module.brush(t,s,o,i,n)}a.splice(0,a.length)}}else"brush"===t?a.push(s):console.error("Unknown call",t,s)}),(async()=>{await r.init(),r.notify_chunk_update=(e,t,r,o,i)=>{r&&o&&i?s.postMessage({event:"chunk",chunkX:e,chunkY:t,posX:r,posY:o,state:i},[r,o,i]):s.postMessage({event:"chunk",chunkX:e,chunkY:t,empty:!0})},s.postMessage({event:"ready"})})()})();